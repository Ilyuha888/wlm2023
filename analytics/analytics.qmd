--- 
title: "Analytics // WLM 2023"
author: "A. Angelgardt"
format: 
  dashboard:
    scrolling: true
    logo: pics/logo.png
---

::: {hidden=true}
## Chunk opts
```{r opts, echo=FALSE, eval=TRUE, message=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      message=FALSE, 
                      eval=TRUE,
                      warning=FALSE)
```
:::

::: {hidden=true}
## Install pkgs
```{r install-pkgs, eval=FALSE}
# install.packages(c("rystats", "googlesheets4"))
# if (!("remotes" %in% installed.packages())) {
#   install.packages("remotes")
# }
# remotes::install_github("datatrail-jhu/rgoogleclassroom")
```
:::


::: {hidden=true}
## Libraries
```{r pkgs}
library(rytstat)
library(googlesheets4)
library(rgoogleclassroom)
library(tidyverse)
theme_set(theme_bw())
library(plotly)
```
:::

::: {hidden=true}
## Auth
```{r auth}
## youtube
ryt_auth('course.wlm@gmail.com')
# ryt_deauth()
# ryt_has_token()
# ryt_user()

## classroom
load("/home/nglgrdt/tokens/classroom_roken.Rdata")
auth_from_secret(access_token = token$credentials$access_token,
                 refresh_token = token$credentials$refresh_token)
```
:::

::: {hidden=true}
## Load data
```{r calendar-data}
source("get_calendar_data.R")
```

```{r lectures-get-data-funcs}
ryt_get_analytics_custom <- function (start_date = Sys.Date() - 14, 
                                      end_date = Sys.Date(), 
                                      metrics = c(
                                        "views", 
                                        "likes",
                                        "dislikes",
                                        "estimatedMinutesWatched",
                                        "averageViewDuration", 
                                        "averageViewPercentage"), 
                                      dimensions = "day", 
                                      filters = NULL, ...) 
{
    require(cli)
    require(gargle)
    cli_alert_info("Compose params")
    metrics <- paste0(metrics, collapse = ",")
    dimensions <- paste0(dimensions, collapse = ",")
    out <- request_build(method = "GET", 
                         params = list(startDate = start_date, 
                                       endDate = end_date, ids = "channel==MINE",
                                       dimensions = dimensions, 
                                       filters = filters, 
                                       metrics = metrics), 
                         token = ryt_token(), 
                         path = "v2/reports", 
                         base_url = "https://youtubeanalytics.googleapis.com/")
    cli_alert_info("Send query")
    ans <- request_retry(out, encode = "json")
    resp <- response_process(ans)
    cli_alert_info("Parse result")
    suppressMessages({
        data <- tibble(response = resp$rows) %>% 
          unnest_wider(.data$response, ...)
    })
    if (nrow(data) == 0) {
        cli_alert_warning("Empty answer")
        return(tibble())
    }
    headers <- tibble(response = resp$columnHeaders) %>%
      unnest_wider(.data$response, ...)
    data <- set_names(data, headers$name)
    cli_alert_success(str_glue("Success, loading {nrow(data)} rows."))
    return(data)
}
```

```{r lectures-data}
ryt_get_videos() %>% 
  select(id_video_id, title) %>%
  filter(!str_detect(title, "внутряк")) -> videos
# video_id_list <- paste0(head(videos$id_video_id, 500), collapse = ',')
dimensions <- c('day', 'video')
metrics <- c("views", "likes", "dislikes", "estimatedMinutesWatched", "averageViewDuration", "averageViewPercentage")
ryt_get_analytics_custom(
  start_date = '2023-11-06', end_date = Sys.Date(),
  dimensions = dimensions,
  metrics    = metrics,
  filters = str_glue('video=={str_c(head(videos$id_video_id, 500), collapse=",")}'), names_sep = ""
) %>% 
  set_names(c(dimensions, metrics)) %>% 
  left_join(videos, join_by("video" == "id_video_id")) -> basics_by_videos
```

```{r quiz-data}
q_journal <- read_sheet("https://docs.google.com/spreadsheets/d/1mNT6A3qJTnS5EXQJg6MKFNinRqOVmrGErMZdrfsN9To/edit?usp=sharing",
                        sheet = "Journal") %>% 
  select(ID, Stream, starts_with("Q"))

q_scores <- tibble()
for(i in paste0("Q", 1:2)) {
  if(i == "Q1") {
    read_sheet("https://docs.google.com/spreadsheets/d/1mNT6A3qJTnS5EXQJg6MKFNinRqOVmrGErMZdrfsN9To/edit?usp=sharing",
                        sheet = i) %>% 
    select(ID, matches("q\\d+-\\d+"), TOTAL) -> q_scores
  } else {
    read_sheet("https://docs.google.com/spreadsheets/d/1mNT6A3qJTnS5EXQJg6MKFNinRqOVmrGErMZdrfsN9To/edit?usp=sharing",
                        sheet = i) %>% 
      select(ID, matches("q\\d+-\\d+"), TOTAL) %>% 
      full_join(q_scores, join_by(ID)) -> q_scores
  }
}

q_spec <- read_sheet("https://docs.google.com/spreadsheets/d/1iCy8MDz-ER95OfylV-xAY6lIxfbCZiHq5NM3i4smm5M/edit?usp=sharing",
                     sheet = "Q") %>% 
  select(task, level, max_score)
```

```{r pr-data}
pr_journal <- read_sheet("https://docs.google.com/spreadsheets/d/1mNT6A3qJTnS5EXQJg6MKFNinRqOVmrGErMZdrfsN9To/edit?usp=sharing",
                        sheet = "Journal") %>% 
  select(ID, Stream, starts_with("P"))
```


```{r c-data}
c_journal <- read_sheet("https://docs.google.com/spreadsheets/d/1mNT6A3qJTnS5EXQJg6MKFNinRqOVmrGErMZdrfsN9To/edit?usp=sharing",
                        sheet = "Journal") %>% 
  select(ID, Stream, starts_with("C"))
```

:::

# L // Лекции {#lec}

```{r lectures-preproc}
basics_by_videos %>% 
  mutate(day = as_date(day)) %>% 
  filter(str_detect(title, "^L")) %>% 
  separate(title, into = c("code", "name", "course", "lab"), sep = " // ") %>% 
  select(-course, - lab) -> lec
```

## Row {height=50%}
```{r lectures-graph-by-day}
(
  calendar_activities %>% 
    filter(str_detect(code, "^P")) %>% 
    ggplot() +
    geom_line(data = lec,
              aes(day, views, color = code)) +
    geom_vline(aes(xintercept = as.numeric(date)),
               linetype = "dashed",
               color = "gray70") +
    geom_text(aes(x = date,
                  y = 0,
                  label = code)) +
    labs(x = "Дата",
         y = "Количество просмотров",
         color = "Лекция",
         title = "Динамика просмотров лекций") +
    scale_x_date(date_breaks = "week",
                 date_minor_breaks = "day") +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 90))
  ) %>% ggplotly() %>% 
  layout(legend = list(orientation = "h", x = .3, y = -.3))
```

## Row {height=50%}

```{r lectures-graph-cumsum}
(
  calendar_activities %>% 
    filter(str_detect(code, "^P")) %>% 
    ggplot() +
    geom_line(data = lec %>% 
                group_by(video) %>% 
                mutate(cum_views = cumsum(views)),
              aes(day, cum_views, color = code)) +
    geom_vline(aes(xintercept = as.numeric(date)),
               linetype = "dashed",
               color = "gray70") +
    geom_text(aes(x = date,
                  y = 0,
                  label = code)) +
    labs(x = "Дата",
         y = "Количество просмотров",
         color = "Лекция",
         title = "Кумулятивная сумма просмотров лекций") +
    scale_x_date(date_breaks = "week",
                 date_minor_breaks = "day") +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 90))
  ) %>% ggplotly() %>% 
  layout(legend = list(orientation = "h", x = .3, y = -.3))
```


# P // Практики {#pr}

## Row
```{r pr-preproc}
pr_journal %>% 
  filter(Stream == "main") %>% 
  select(-Stream) %>% 
  pivot_longer(-ID, 
               names_to = "practice",
               values_to = "present") %>% 
  separate(practice, into = c("practice", "half"), sep = "-") %>% 
  group_by(practice, half) %>% 
  mutate(present = as.numeric(present),
         practice = factor(practice,
                           ordered = TRUE,
                           levels = paste0("P", 1:17))) %>%
  replace_na(list(present = 0)) %>% 
  summarise(count = sum(present),
            percentage = mean(present) %>% round(2)) -> pr

basics_by_videos %>% 
  mutate(day = as_date(day)) %>% 
  filter(str_detect(title, "^P")) %>% 
  separate(title, into = c("code", "name", "course", "lab"), sep = " // ") %>% 
  select(-course, - lab) -> pr_videos
```

```{r pr-graph-presence}
(
  pr %>% 
    ggplot(aes(practice, percentage, color = half, group = half)) +
    geom_line() +
    geom_point() +
    scale_y_continuous(limits = c(0, 1)) +
    scale_color_discrete(labels = c(`1` = "первая", `2` = "вторая")) +
    labs(x = "Практика",
         y = "Доля присутствовавших",
         color = "Часть практики",
         title = "Динамика посещения практик") +
    theme(legend.position = "bottom")
) %>% ggplotly() %>% 
  layout(legend = list(orientation = "h", x = 0.3, y = -.3))
```

## Row

```{r practice-graph-by-day}
(
  calendar_assessment %>% 
    filter(str_detect(code, "^HW")) %>% 
    ggplot() +
    geom_line(data = pr_videos,
              aes(day, views, color = code)) +
    geom_vline(aes(xintercept = as.numeric(date),
                   linetype = deadline),
               color = "gray70") +
    geom_text(aes(x = date,
                  y = 0,
                  label = code)) +
    labs(x = "Дата",
         y = "Количество просмотров",
         color = "Лекция",
         linetype = "Дедлайн",
         title = "Динамика просмотров записей практик") +
    scale_x_date(date_breaks = "week",
                 date_minor_breaks = "day") +
    scale_linetype_manual(values = c(hard = "dashed", soft = "dotted"),
                          labels = c(hard = "жёсткий", soft = "мягкий")) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 90))
  ) %>% ggplotly() %>% 
  layout(legend = list(orientation = "h", x = .3, y = -.5))
```

## Row

```{r pr-graph-cumsum}
(
  calendar_assessment %>% 
    filter(str_detect(code, "^HW")) %>% 
    ggplot() +
    geom_line(data = pr_videos %>% 
                group_by(video) %>% 
                mutate(cum_views = cumsum(views)),
              aes(day, cum_views, color = code)) +
    geom_vline(aes(xintercept = as.numeric(date),
                   linetype = deadline),
               color = "gray70") +
    geom_text(aes(x = date,
                  y = 0,
                  label = code)) +
    labs(x = "Дата",
         y = "Количество просмотров",
         color = "Лекция",
         title = "Кумулятивная сумма просмотров записей практик") +
    scale_x_date(date_breaks = "week",
                 date_minor_breaks = "day") +
    scale_linetype_manual(values = c(hard = "dashed", soft = "dotted"),
                          labels = c(hard = "жёсткий", soft = "мягкий")) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 90))
  ) %>% ggplotly() %>% 
  layout(legend = list(orientation = "h", x = .3, y = -.5))
```


# Q // Квизы {#q}

```{r get-course-id}
get_course_list() %>% 
  filter(name == "WLM 2023 // HSE UX LAB") %>% 
  .$id -> course_id
```




# HW // Домашки {#hw}

# С // Консультации {#c}

## Row
```{r c-preproc}
c_journal %>% 
  filter(Stream == "main") %>% 
  select(-Stream) %>% 
  pivot_longer(-ID, 
               names_to = "consultation",
               values_to = "present") %>% 
  group_by(consultation) %>% 
  mutate(present = as.numeric(present),
         consultation = factor(consultation,
                           ordered = TRUE,
                           levels = paste0("C", 1:17))) %>%
  replace_na(list(present = 0)) %>% 
  summarise(count = sum(present),
            percentage = mean(present) %>% round(2)) -> c

basics_by_videos %>% 
  mutate(day = as_date(day)) %>% 
  filter(str_detect(title, "^С|^C")) %>% 
  separate(title, into = c("code", "course", "lab"), sep = " // ") %>% 
  select(-course, - lab) -> c_videos
```

```{r c-graph-presence}
(
  c %>% 
    ggplot(aes(consultation, percentage, group = 1)) +
    geom_line() +
    geom_point() +
    scale_y_continuous(limits = c(0, 1)) +
    labs(x = "Консультация",
         y = "Доля присутствовавших",
         title = "Динамика посещения консультаций")
) %>% ggplotly() %>% 
  layout(legend = list(orientation = "h", x = 0.3, y = -.3))
```

## Row

```{r c-graph-by-day}
(
  calendar_assessment %>% 
    filter(str_detect(code, "^HW")) %>% 
    ggplot() +
    geom_line(data = c_videos,
              aes(day, views, color = code)) +
    geom_vline(aes(xintercept = as.numeric(date),
                   linetype = deadline),
               color = "gray70") +
    geom_text(aes(x = date,
                  y = 0,
                  label = code)) +
    labs(x = "Дата",
         y = "Количество просмотров",
         color = "Лекция",
         linetype = "Дедлайн",
         title = "Динамика просмотров записей консультаций") +
    scale_x_date(date_breaks = "week",
                 date_minor_breaks = "day") +
    scale_linetype_manual(values = c(hard = "dashed", soft = "dotted"),
                          labels = c(hard = "жёсткий", soft = "мягкий")) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 90))
  ) %>% ggplotly() %>% 
  layout(legend = list(orientation = "h", x = .3, y = -.5))
```

## Row

```{r c-graph-cumsum}
(
  calendar_assessment %>% 
    filter(str_detect(code, "^HW")) %>% 
    ggplot() +
    geom_line(data = c_videos %>% 
                group_by(video) %>% 
                mutate(cum_views = cumsum(views)),
              aes(day, cum_views, color = code)) +
    geom_vline(aes(xintercept = as.numeric(date),
                   linetype = deadline),
               color = "gray70") +
    geom_text(aes(x = date,
                  y = 0,
                  label = code)) +
    labs(x = "Дата",
         y = "Количество просмотров",
         color = "Лекция",
         title = "Кумулятивная сумма просмотров записей консультаций") +
    scale_x_date(date_breaks = "week",
                 date_minor_breaks = "day") +
    scale_linetype_manual(values = c(hard = "dashed", soft = "dotted"),
                          labels = c(hard = "жёсткий", soft = "мягкий")) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 90))
  ) %>% ggplotly() %>% 
  layout(legend = list(orientation = "h", x = .3, y = -.5))
```



# A // Разборы {#a}

## Row
```{r a-preproc}
basics_by_videos %>% 
  mutate(day = as_date(day)) %>% 
  filter(str_detect(title, "^A|^А")) %>% 
  separate(title, into = c("code", "name", "course", "lab"), sep = " // ") %>% 
  select(-course, - lab) -> a_videos
```

```{r a-graph-by-day}
(
  calendar_assessment %>% 
    filter(str_detect(code, "^HW")) %>% 
    ggplot() +
    geom_line(data = a_videos,
              aes(day, views, color = code)) +
    geom_vline(aes(xintercept = as.numeric(date),
                   linetype = deadline),
               color = "gray70") +
    geom_text(aes(x = date,
                  y = 0,
                  label = code)) +
    labs(x = "Дата",
         y = "Количество просмотров",
         color = "Лекция",
         linetype = "Дедлайн",
         title = "Динамика просмотров разборов") +
    scale_x_date(date_breaks = "week",
                 date_minor_breaks = "day") +
    scale_linetype_manual(values = c(hard = "dashed", soft = "dotted"),
                          labels = c(hard = "жёсткий", soft = "мягкий")) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 90))
  ) %>% ggplotly() %>% 
  layout(legend = list(orientation = "h", x = .3, y = -.5))
```

## Row

```{r a-graph-cumsum}
(
  calendar_assessment %>% 
    filter(str_detect(code, "^HW")) %>% 
    ggplot() +
    geom_line(data = a_videos %>% 
                group_by(video) %>% 
                mutate(cum_views = cumsum(views)),
              aes(day, cum_views, color = code)) +
    geom_vline(aes(xintercept = as.numeric(date),
                   linetype = deadline),
               color = "gray70") +
    geom_text(aes(x = date,
                  y = 0,
                  label = code)) +
    labs(x = "Дата",
         y = "Количество просмотров",
         color = "Лекция",
         title = "Кумулятивная сумма просмотров разборов") +
    scale_x_date(date_breaks = "week",
                 date_minor_breaks = "day") +
    scale_linetype_manual(values = c(hard = "dashed", soft = "dotted"),
                          labels = c(hard = "жёсткий", soft = "мягкий")) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 90))
  ) %>% ggplotly() %>% 
  layout(legend = list(orientation = "h", x = .3, y = -.5))
```