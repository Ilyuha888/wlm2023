--- 
title: "Analytics // WLM 2023"
author: "A. Angelgardt"
format: 
  dashboard:
    scrolling: true
    logo: pics/logo.png
---

::: {hidden=true}

## Chunk opts
```{r opts, echo=FALSE, eval=TRUE, message=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      message=FALSE, 
                      eval=TRUE,
                      warning=FALSE)
```


## Install pkgs
```{r install-pkgs, eval=FALSE}
# install.packages(c("rystats", "googlesheets4"))
# if (!("remotes" %in% installed.packages())) {
#   install.packages("remotes")
# }
# remotes::install_github("datatrail-jhu/rgoogleclassroom")
```


## Libraries
```{r pkgs}
library(rytstat)
library(googlesheets4)
library(rgoogleclassroom)
library(tidyverse)
theme_set(theme_bw())
theme_update(legend.position = "bottom")
library(plotly)
```

```{r auth}
## youtube
ryt_auth('course.wlm@gmail.com')
# ryt_deauth()
# ryt_has_token()
# ryt_user()

## gs4 auth
gs4_auth("a.n.angelgardt@gmail.com")

## classroom
load("/home/nglgrdt/tokens/classroom_token.Rdata")
# load("/home/angelgardt/tokens/classroom_token.Rdata")
auth_from_secret(access_token = token$credentials$access_token,
                 refresh_token = token$credentials$refresh_token)
```


## Load data

### Spec

```{r get-spec-data}
## homeworks
hw_spec <- read_sheet("https://docs.google.com/spreadsheets/d/1iCy8MDz-ER95OfylV-xAY6lIxfbCZiHq5NM3i4smm5M/edit?usp=sharing",
                      sheet = "HW") %>% 
  select(task, level)

## quizes
q_sp <- read_sheet("https://docs.google.com/spreadsheets/d/1iCy8MDz-ER95OfylV-xAY6lIxfbCZiHq5NM3i4smm5M/edit?usp=sharing",
                     sheet = "Q") %>% 
  select(task_code, level, max_score)
```

### Calendar

```{r get-calendar-data}
read_sheet("https://docs.google.com/spreadsheets/d/1k9QtNjZLzTrbYlkXrWFWxglXTG5kol1DHSPIN9stLiE/edit?usp=sharing",
           sheet = "План", skip = 2) -> calendar
calendar %>% 
  select(date, code_1) %>% 
  filter(str_detect(code_1, "^L|^P|^C|^A")) %>% 
  mutate(date = as_date(date, format = "%d/%m/%y")) %>% 
  rename("code" = "code_1") -> calendar_activities

calendar %>%
  select(code_2, deadline_soft, deadline_hard) %>%
  filter(str_detect(code_2, "^Q|^HW")) %>%
  mutate(deadline_soft = as_datetime(deadline_soft, format = "%d/%m/%y %H:%M") %>% date(),
         deadline_hard = as_datetime(deadline_hard, format = "%d/%m/%y %H:%M") %>% date()) %>%
  rename("code" = "code_2") %>% 
  pivot_longer(-code, names_to = "deadline", values_to = "date") %>% 
  mutate(deadline = str_remove(deadline, "deadline_")) -> calendar_assessment

```

### Journal

```{r get-journal-data}
## practice
journal <- read_sheet("https://docs.google.com/spreadsheets/d/1mNT6A3qJTnS5EXQJg6MKFNinRqOVmrGErMZdrfsN9To/edit?usp=sharing",
                         sheet = "Journal", col_types = "c")
journal %>% 
  select(ID, Stream, starts_with("P")) -> pr_journal

## calculate number of participants
pr_journal %>% 
  filter(Stream == "main") %>% 
  summarise(n = n()) %>% 
  .$n -> n_partic

## practice presence
pr_journal %>% 
  filter(Stream == "main") %>% 
  select(-Stream) %>% 
  pivot_longer(-ID, 
               names_to = "practice",
               values_to = "present") %>% 
  separate(practice, into = c("practice", "half"), sep = "-") %>% 
  group_by(practice, half) %>% 
  mutate(present = as.numeric(present),
         practice = factor(practice,
                           ordered = TRUE,
                           levels = paste0("P", 1:17))) %>%
  replace_na(list(present = 0)) %>% 
  summarise(count = sum(present),
            percentage = mean(present) %>% round(2)) -> pr



## consulations
journal %>% 
  select(ID, Stream, starts_with("C")) -> c_journal

## consulations presence
c_journal %>% 
  filter(Stream == "main") %>% 
  select(-Stream) %>% 
  pivot_longer(-ID, 
               names_to = "consultation",
               values_to = "present") %>% 
  group_by(consultation) %>% 
  mutate(present = as.numeric(present),
         consultation = factor(consultation,
                               ordered = TRUE,
                               levels = paste0("C", 1:17))) %>%
  replace_na(list(present = 0)) %>% 
  summarise(count = sum(present),
            percentage = mean(present) %>% round(2)) -> cons



## homeworks
journal %>% 
  select(ID, Stream, matches("^HW\\d+")) -> hw_journal

## homeworks not submitted
hw_journal %>% 
  filter(Stream == "main") %>% 
  pivot_longer(cols = -c(ID, Stream),
               names_to = "hw",
               values_to = "score") %>% 
  filter(score == "NS") %>% 
  group_by(hw) %>% 
  summarise(n = n()) -> hws_ns

## homeworks scores
hw_journal %>% 
  filter(Stream == "main") %>%
  select(-Stream) %>% 
  pivot_longer(cols = -ID,
               names_to = "hw",
               values_to = "score") %>% 
  filter(score != "NS") %>% 
  mutate(score = as.numeric(score),
         hw = factor(hw, 
                     ordered = TRUE,
                     levels = paste0("HW", 1:16))) -> hws_scores

## homework sheets
sheet_names("https://docs.google.com/spreadsheets/d/1mNT6A3qJTnS5EXQJg6MKFNinRqOVmrGErMZdrfsN9To/edit?usp=sharing") %>% 
  str_extract("^HW\\d+") %>% 
  na.omit() -> hws_sheets

## homework tasks
hw_tsks <- tibble()
for (i in 1:length(hws_sheets)) {
  read_sheet("https://docs.google.com/spreadsheets/d/1mNT6A3qJTnS5EXQJg6MKFNinRqOVmrGErMZdrfsN9To/edit?usp=sharing",
             sheet = hws_sheets[i], col_types = "c") %>% 
    select(ID, starts_with("hw")) %>% 
    pivot_longer(-ID, names_to = "task", values_to = "score") %>% 
    bind_rows(hw_tsks) -> hw_tsks
}

## homework tasks preprocess
hw_tsks %>%
  left_join(hw_spec,
            join_by(task)) %>%
  separate(task, into = c("hw", "task")) %>%
  mutate(task = factor(task,
                       ordered = TRUE,
                       levels = as.character(1:15)),
         level = factor(level,
                        ordered = TRUE,
                        levels = c("easy", "medium", "hard", "extreme"))) %>%
  mutate(hw = toupper(hw)) -> hw_tasks



## quizes
# q_journal <- read_sheet("https://docs.google.com/spreadsheets/d/1mNT6A3qJTnS5EXQJg6MKFNinRqOVmrGErMZdrfsN9To/edit?usp=sharing",
#                         sheet = "Journal") %>% 
#   select(ID, Stream, starts_with("Q"))


# q_scores <- tibble()
# for(i in paste0("Q", 1:2)) {
#   if(i == "Q1") {
#     read_sheet("https://docs.google.com/spreadsheets/d/1mNT6A3qJTnS5EXQJg6MKFNinRqOVmrGErMZdrfsN9To/edit?usp=sharing",
#                sheet = i) %>% 
#       select(ID, matches("q\\d+-\\d+"), TOTAL) -> q_scores
#   } else {
#     read_sheet("https://docs.google.com/spreadsheets/d/1mNT6A3qJTnS5EXQJg6MKFNinRqOVmrGErMZdrfsN9To/edit?usp=sharing",
#                sheet = i) %>% 
#       select(ID, matches("q\\d+-\\d+"), TOTAL) %>% 
#       full_join(q_scores, join_by(ID)) -> q_scores
#   }
# }

```

### YouTube

```{r get-yt-data}
## custom load function
## package function seems to have a bug
ryt_get_analytics_custom <- function (start_date = Sys.Date() - 14, 
                                      end_date = Sys.Date(), 
                                      metrics = c(
                                        "views", 
                                        "likes",
                                        "dislikes",
                                        "estimatedMinutesWatched",
                                        "averageViewDuration", 
                                        "averageViewPercentage"), 
                                      dimensions = "day", 
                                      filters = NULL, ...) 
{
  require(cli)
  require(gargle)
  cli_alert_info("Compose params")
  metrics <- paste0(metrics, collapse = ",")
  dimensions <- paste0(dimensions, collapse = ",")
  out <- request_build(method = "GET", 
                       params = list(startDate = start_date, 
                                     endDate = end_date, ids = "channel==MINE",
                                     dimensions = dimensions, 
                                     filters = filters, 
                                     metrics = metrics), 
                       token = ryt_token(), 
                       path = "v2/reports", 
                       base_url = "https://youtubeanalytics.googleapis.com/")
  cli_alert_info("Send query")
  ans <- request_retry(out, encode = "json")
  resp <- response_process(ans)
  cli_alert_info("Parse result")
  suppressMessages({
    data <- tibble(response = resp$rows) %>% 
      unnest_wider(.data$response, ...)
  })
  if (nrow(data) == 0) {
    cli_alert_warning("Empty answer")
    return(tibble())
  }
  headers <- tibble(response = resp$columnHeaders) %>%
    unnest_wider(.data$response, ...)
  data <- set_names(data, headers$name)
  cli_alert_success(str_glue("Success, loading {nrow(data)} rows."))
  return(data)
}




ryt_get_videos() %>% 
  select(id_video_id, title) %>%
  filter(!str_detect(title, "внутряк")) -> videos

# video_id_list <- paste0(head(videos$id_video_id, 500), collapse = ',')

dimensions <- c('day', 'video')
metrics <- c("views", "likes", "dislikes", "estimatedMinutesWatched", "averageViewDuration", "averageViewPercentage")

ryt_get_analytics_custom(
  start_date = '2023-11-06', end_date = Sys.Date(),
  dimensions = dimensions,
  metrics    = metrics,
  filters = str_glue('video=={str_c(head(videos$id_video_id, 500), collapse=",")}'), names_sep = ""
) %>% 
  set_names(c(dimensions, metrics)) %>% 
  left_join(videos, join_by("video" == "id_video_id")) -> basics_by_videos

basics_by_videos %>% 
  mutate(day = as_date(day)) %>% 
  filter(str_detect(title, "^L")) %>% 
  separate(title, into = c("code", "name", "course", "lab"), sep = " // ") %>% 
  select(-course, - lab) -> lec

basics_by_videos %>% 
  mutate(day = as_date(day)) %>% 
  filter(str_detect(title, "^P")) %>% 
  separate(title, into = c("code", "name", "course", "lab"), sep = " // ") %>% 
  select(-course, - lab) -> pr_videos

basics_by_videos %>% 
  mutate(day = as_date(day)) %>% 
  filter(str_detect(title, "^С|^C")) %>% 
  separate(title, into = c("code", "course", "lab"), sep = " // ") %>% 
  select(-course, - lab) -> cons_videos

basics_by_videos %>% 
  mutate(day = as_date(day)) %>% 
  filter(str_detect(title, "^A|^А")) %>% 
  separate(title, into = c("code", "name", "course", "lab"), sep = " // ") %>% 
  select(-course, - lab) -> a_videos
```


### Classroom

```{r get-classroom-data, eval=FALSE}
get_course_list() %>% 
  .$courses %>% 
  filter(name == "WLM 2023 // HSE UX LAB") %>% 
  .$id -> course_id

get_coursework_list(course_id)$courseWork %>% 
  select(id, title) %>%
  filter(str_detect(title, "^Q")) %>% 
  mutate(code = str_extract(title, "^Q\\d+")) -> q_ids

tibble(
  Q1 = "https://docs.google.com/forms/d/1WrlABMSqcQY03Wefboe3E9uTXSxPW1o-Z6esk4qPSuM/edit#responses",
  Q2 = "https://docs.google.com/forms/d/1muDdJjr0ZIwHFYuDRK9YBbQlsxXfd8fJM1dNdyFOaMk/edit#responses",
  Q3 = "https://docs.google.com/forms/d/1lRFq_QXwI-LSXNDsZksgZLJ7in33fANNslYmlS3qUk0/edit#responses",
  Q4 = "https://docs.google.com/forms/d/1VqekS1ApzQ74QxaQ1O-B9oPjjJ8c2QyRwe1DS9PEZKg/edit#responses",
  Q5 = "https://docs.google.com/forms/d/1uq3i_Zz-ArIG0ILGxlLmFIMqGscVkKv7PHZe6LoFF4c/edit#responses",
  Q6 = "https://docs.google.com/forms/d/17fPOx52-RK-hxDUsrD5hei0Uw7ScdWwfKpD_1fb8AWw/edit#responses",
  Q7 = "https://docs.google.com/forms/d/1Ywo9r_EF9qEeV9PbG70EMm95ci2XM2S-b9IgCPjYBLI/edit#responses",
  Q8 = "https://docs.google.com/forms/d/1JItuzbpNIemDLYFYI43pi_GGy_vmdpLWAauZzLNv0dE/edit#responses",
  Q9 = "https://docs.google.com/forms/d/177eGZsat4ntKKFoS-YKbZ3GuZnzTaB4-vwh2lYTYwK0/edit#responses",
  Q10 = "https://docs.google.com/forms/d/1EzNjUV5653DYEEsFXeIdgT98pEqEmcMh0hTVwlna-3Q/edit#responses",
  Q11 = "https://docs.google.com/forms/d/1KTfflQIUL_VMsSB8W3KgXmLVu32VagUVycnOe08UN6o/edit#responses",
  Q12 = "https://docs.google.com/forms/d/1WfDmr8Sds-hCrnL5oaBVGx_C2EzwvTBcCL1Ph2Dxebw/edit#responses",
  Q13 = "https://docs.google.com/forms/d/1ffHuvBGiM7ctNozoH6TJgrU_Asp1oMaJMoMvFDiURbw/edit#responses",
  Q14 = "https://docs.google.com/forms/d/1HBJ78eluyw29GNnRHlG5Yqtc_inclX9tJ_S5FpwNwNk/edit#responses",
  Q15 = "https://docs.google.com/forms/d/1dG1AAOkA8vT8GyfPKklK5oeEAXRNBIiQcHyasQIYfxk/edit#responses"
) %>% pivot_longer(cols = everything(),
                   names_to = "code",
                   values_to = "link") -> q_links

# get_coursework_properties(course_id, coursework_id)
# get_form_properties(form_id = NULL, form_url = NULL)

## quiz specification preprocess
q_sp %>% 
  mutate(code = task_code %>% 
           str_extract("^q\\d+") %>% 
           toupper(),
         task = task_code %>% 
           str_extract("\\d+$") %>% 
           factor(ordered = TRUE,
                  levels = as.character(1:20)),
         level = level %>% 
           factor(ordered = TRUE,
                  levels = c("easy", "medium", "hard", "extreme"))) -> q_spec

q_spec %>% 
  group_by(code) %>% 
  summarise(max_total_score = sum(max_score)) -> q_max_total_scores

### quizes preproc
source("scripts/q-preproc/q1_preproc.R")
source("scripts/q-preproc/q2_preproc.R")


q1_total_scores %>% 
  bind_rows(q2_total_scores) %>% 
  left_join(q_max_total_scores,
            join_by(code)) %>% 
  mutate(lastSubmittedTime = as_datetime(lastSubmittedTime),
         totalScore100 = (totalScore / max_total_score * 100) %>% round()) %>% 
  filter(month(lastSubmittedTime) > 10) -> q_total_scores

q1_item_score %>% 
  bind_rows(q2_item_score) -> q_item_scores



# get_form_responses(form_url = q_links$link[15]) -> q15
```

```{r get-aesthetics}
aesth <- yaml::read_yaml("aesthetics.yml")
```

:::





# L // Лекции {#lec}


## Row

```{r lectures-views-by-day}
calendar_activities %>%
  filter(str_detect(code, "^P")) %>%
  ggplot() +
  geom_line(data = lec,
            aes(day, views, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date)),
             linetype = "dashed",
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Количество просмотров",
    color = "Лекция",
    title = "Динамика просмотров лекций"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) -> lec_views_dynamics

lec_views_dynamics %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


```{r lectures-graph-cumsum-views}
calendar_activities %>%
  filter(str_detect(code, "^P")) %>%
  ggplot() +
  geom_line(
    data = lec %>%
      group_by(video) %>%
      mutate(cum_views = cumsum(views)),
    aes(day, cum_views, color = code)
  ) +
  geom_vline(aes(xintercept = as.numeric(date)),
             linetype = "dashed",
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Количество просмотров",
    color = "Лекция",
    title = "Кумулятивная сумма просмотров лекций"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) -> lec_cumsum_views

lec_cumsum_views %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

## Row

```{r lectures-ave-view-dur-by-day}
calendar_activities %>%
  filter(str_detect(code, "^P")) %>%
  ggplot() +
  geom_line(data = lec,
            aes(day, averageViewDuration, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date)),
             linetype = "dashed",
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Средняя продолжительность\nвоспроизведения видео, с",
    color = "Лекция",
    title = "Абсолютная продолжительность просмотра лекций"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) -> lec_ave_views_dur

lec_ave_views_dur %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


```{r lectures-ave-view-perc-by-day}
calendar_activities %>%
  filter(str_detect(code, "^P")) %>%
  ggplot() +
  geom_line(data = lec,
            aes(day, averageViewPercentage, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date)),
             linetype = "dashed",
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Средняя доля\nвоспроизведения видео, %",
    color = "Лекция",
    title = "Относительная продолжительность просмотра лекций"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) -> lec_ave_views_perc

lec_ave_views_perc %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```




# P // Практики {#pr}


## Row

```{r pr-graph-visits}
pr %>%
  ggplot(aes(practice, percentage, color = half, group = half)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_discrete(labels = c(`1` = "первая", `2` = "вторая")) +
  labs(
    x = "Практика",
    y = "Доля присутствовавших",
    color = "Часть практики",
    title = "Динамика посещения практик"
  ) -> pr_visits

pr_visits %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


## Row

```{r practice-views-by-day}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(data = pr_videos,
            aes(day, views, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Количество просмотров",
    color = "Практика",
    linetype = "Дедлайн",
    title = "Динамика просмотров записей практик"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(axis.text.x = element_text(angle = 90)) -> pr_vids_views

pr_vids_views %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```



```{r practice-views-cumsum}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(
    data = pr_videos %>%
      group_by(video) %>%
      mutate(cum_views = cumsum(views)),
    aes(day, cum_views, color = code)
  ) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Количество просмотров",
    color = "Практика",
    linetype = "Дедлайн",
    title = "Кумулятивная сумма просмотров записей практик"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(axis.text.x = element_text(angle = 90)) -> pr_vids_cumsum_views

pr_vids_cumsum_views %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


## Row

```{r practice-ave-view-dur-by-day}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(data = pr_videos,
            aes(day, averageViewDuration, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline,),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Средняя продолжительность\nвоспроизведения видео, с",
    color = "Практика",
    linetype = "Дедлайн",
    title = "Абсолютная продолжительность просмотра практик"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) -> pr_ave_views_dur

pr_ave_views_dur %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


```{r practice-ave-view-perc-by-day}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(data = pr_videos,
            aes(day, averageViewPercentage, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Средняя доля\nвоспроизведения видео, %",
    color = "Практика",
    linetype = "Дедлайн",
    title = "Относительная продолжительность просмотра практик"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) -> pr_ave_views_perc

pr_ave_views_perc %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```





# Q // Квизы {#q}

## Row {.tabset}

```{r q1-ts, eval=FALSE}
#| title: Q1

q_total_scores %>% 
  filter(code == "Q1") %>% 
  ggplot(aes(totalScore100)) +
  geom_histogram() +
  scale_x_continuous(breaks = seq(0, 100, by = 5))

q_item_scores %>%
  filter(str_detect(task_code, "^q1")) %>% 
  summarise(score = sum(score),
            .by = c(itemId, task_code, responseId)) %>% 
  left_join(q_total_scores %>% 
              filter(code == "Q1"),
            join_by(responseId))
  group_by(task_code) %>% 
  
  summarise(mean = mean(score)) %>% 
  
  left_join(q_spec, join_by())

```


# HW // Домашки {#hw}


## Row

```{r hws-ns}
hws_ns %>%
  ggplot(aes(hw, n)) +
  geom_col() +
  geom_text(aes(
    y = n - 1,
    label = (n / n_partic * 100) %>% round() %>% paste0("%")
  ),
  color = "white") +
  labs(
    x = "Домашка",
    y = "Количество не сдавших",
    title = "Динамика сдачи домашек",
    caption = "лейблы отображают процент не сдавших"
  ) -> hw_ns_graph

hw_ns_graph %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hws-mean-scores}
hws_scores %>%
  group_by(hw) %>%
  summarise(mean = mean(score) %>% round(2),
            sd = sd(score) %>% round(2)) %>%
  pivot_longer(-hw,
               names_to = "stat") %>%
  ggplot(aes(hw, value, color = stat, group = stat)) +
  geom_line() +
  geom_point(shape = 21, size = 2) +
  geom_hline(yintercept = 20, linetype = "dashed", color = "gray50") + 
  geom_hline(yintercept = 30, linetype = "dotted", color = "gray50") + 
  scale_color_discrete(labels = c(mean = "Среднее",
                                  sd = "Стандартное отклонение")) +
  labs(
    x = "Домашка",
    y = "Значение",
    color = "Метрика",
    title = "Средний балл по сданным домашкам"
  ) -> hw_mean_score

hw_mean_score %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```




## Row

```{r hws-scores}
hws_scores %>%
  ggplot(aes(score)) +
  geom_histogram(binwidth = 1) +
  facet_wrap(~ hw) +
  labs(x = "Балл",
       y = "Количество",
       title = "Распределение баллов домашек") -> hw_score_dist

hw_score_dist %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


## Row {.tabset}

```{r hw1-tab}
#| title: HW1

hw_tasks %>%
  filter(hw == "HW1") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw1_stats

hw1_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw2-tab}
#| title: HW2

hw_tasks %>%
  filter(hw == "HW2") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw2_stats

hw2_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw3-tab}
#| title: HW3

hw_tasks %>%
  filter(hw == "HW3") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw3_stats

hw3_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw4-tab}
#| title: HW4

hw_tasks %>%
  filter(hw == "HW2") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw4_stats

hw4_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw5-tab}
#| title: HW5

hw_tasks %>%
  filter(hw == "HW5") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw5_stats

hw5_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw6-tab}
#| title: HW6

hw_tasks %>%
  filter(hw == "HW6") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw6_stats

hw6_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw7-tab}
#| title: HW7

hw_tasks %>%
  filter(hw == "HW7") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw7_stats

hw7_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw8-tab}
#| title: HW8

hw_tasks %>%
  filter(hw == "HW8") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw8_stats

hw8_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw9-tab}
#| title: HW9

hw_tasks %>%
  filter(hw == "HW9") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw9_stats

hw9_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw10-tab}
#| title: HW10

hw_tasks %>%
  filter(hw == "HW10") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw10_stats

hw10_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw11-tab}
#| title: HW11

hw_tasks %>%
  filter(hw == "HW11") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw11_stats

hw11_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw12-tab}
#| title: HW12

hw_tasks %>%
  filter(hw == "HW12") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw12_stats

hw12_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw13-tab}
#| title: HW13

hw_tasks %>%
  filter(hw == "HW13") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw13_stats

hw13_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw14-tab}
#| title: HW14

hw_tasks %>%
  filter(hw == "HW14") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw14_stats

hw14_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw15-tab}
#| title: HW15

hw_tasks %>%
  filter(hw == "HW15") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw15_stats

hw15_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

```{r hw16-tab}
#| title: HW16

hw_tasks %>%
  filter(hw == "HW16") %>%
  drop_na() %>%
  mutate(score = as.numeric(score)) %>% 
  left_join(hws_scores %>%
              rename(total_score = score),
            join_by(ID, hw)) %>%
  group_by(task, level) %>%
  summarise(
    ns_prop = mean(is.na(score)) %>% round(2),
    difficulty = (mean(score, na.rm = TRUE) / 2) %>% round(2),
    discrimination = cor(score, total_score) %>% round(2)
  ) %>%
  replace_na(list(discrimination = 0)) %>%
  pivot_longer(-c(task, level), names_to = "metrics") %>%
  ggplot(aes(task,
             value,
             shape = metrics,
             fill = level,
             color = level)) +
  geom_point(size = 2, alpha = .7) +
  geom_hline(
    yintercept = c(.1, .9),
    linetype = "dashed",
    color = "gray50"
  ) +
  geom_hline(
    yintercept = c(.25),
    linetype = "dotted",
    color = "gray50"
  ) +
  # scale_x_continuous(breaks = 1:15) +
  scale_fill_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_color_manual(
    values = c(
      easy = aesth$levels$easy,
      medium = aesth$levels$medium,
      hard = aesth$levels$hard,
      extreme = aesth$levels$extreme
    )
  ) +
  scale_shape_manual(
    values = c(
      difficulty = aesth$metrics$difficilty,
      ns_prop = aesth$metrics$ns_prop,
      discrimination = aesth$metrics$discrimination
    )
  ) +
  labs(
    x = "Задание",
    y = "Значение",
    shape = "Метрика",
    fill = "Уровень сложности",
    color = "Уровень сложности"
  ) -> hw16_stats

hw16_stats %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```





# С // Консультации {#c}


## Row

```{r c-graph-presence}
cons %>%
  ggplot(aes(consultation, percentage, group = 1)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(limits = c(0, 1)) +
  labs(x = "Консультация",
       y = "Доля присутствовавших",
       title = "Динамика посещения консультаций") -> cons_visits

cons_visits %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


## Row

```{r cons-views-by-day}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(data = cons_videos,
            aes(day, views, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Количество просмотров",
    color = "Лекция",
    linetype = "Дедлайн",
    title = "Динамика просмотров записей консультаций"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(axis.text.x = element_text(angle = 90)) -> cons_views

cons_views %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


```{r cons-views-cumsum}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(
    data = cons_videos %>%
      group_by(video) %>%
      mutate(cum_views = cumsum(views)),
    aes(day, cum_views, color = code)
  ) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Количество просмотров",
    color = "Лекция",
    title = "Кумулятивная сумма просмотров записей консультаций"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(axis.text.x = element_text(angle = 90)) -> cons_cumsum

cons_cumsum %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


## Row

```{r cons-ave-view-dur-by-day}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(data = cons_videos,
            aes(day, averageViewDuration, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline,),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Средняя продолжительность\nвоспроизведения видео, с",
    color = "Практика",
    linetype = "Дедлайн",
    title = "Абсолютная продолжительность просмотра конслультаций"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) -> cons_ave_views_dur

cons_ave_views_dur %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


```{r cons-ave-view-perc-by-day}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(data = cons_videos,
            aes(day, averageViewPercentage, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Средняя доля\nвоспроизведения видео, %",
    color = "Практика",
    linetype = "Дедлайн",
    title = "Относительная продолжительность просмотра консультаций"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) -> cons_ave_views_perc

cons_ave_views_perc %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```




# A // Разборы {#a}


## Row

```{r a-views-by-day}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(data = a_videos,
            aes(day, views, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Количество просмотров",
    color = "Лекция",
    linetype = "Дедлайн",
    title = "Динамика просмотров разборов"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(axis.text.x = element_text(angle = 90)) -> a_views

a_views %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


```{r a-views-cumsum}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(
    data = a_videos %>%
      group_by(video) %>%
      mutate(cum_views = cumsum(views)),
    aes(day, cum_views, color = code)
  ) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Количество просмотров",
    color = "Лекция",
    title = "Кумулятивная сумма просмотров разборов"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(axis.text.x = element_text(angle = 90)) -> a_views_cumsum

a_views_cumsum %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


## Row

```{r a-ave-view-dur-by-day}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(data = a_videos,
            aes(day, averageViewDuration, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline,),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Средняя продолжительность\nвоспроизведения видео, с",
    color = "Практика",
    linetype = "Дедлайн",
    title = "Абсолютная продолжительность просмотра разборов"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) -> a_ave_views_dur

a_ave_views_dur %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```


```{r a-ave-view-perc-by-day}
calendar_assessment %>%
  filter(str_detect(code, "^HW")) %>%
  ggplot() +
  geom_line(data = a_videos,
            aes(day, averageViewPercentage, color = code)) +
  geom_vline(aes(xintercept = as.numeric(date),
                 linetype = deadline),
             color = "gray70") +
  geom_text(aes(x = date,
                y = 0,
                label = code)) +
  labs(
    x = "Дата",
    y = "Средняя доля\nвоспроизведения видео, %",
    color = "Практика",
    linetype = "Дедлайн",
    title = "Относительная продолжительность просмотра разборов"
  ) +
  scale_x_date(date_breaks = "week",
               date_minor_breaks = "day") +
  scale_linetype_manual(
    values = c(hard = "dashed", soft = "dotted"),
    labels = c(hard = "жёсткий", soft = "мягкий")
  ) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90)) -> a_ave_views_perc

a_ave_views_perc %>% 
  ggplotly() %>% 
  layout(legend = list(
    orientation = "h",
    x = 0, y = -.3
  ))
```

# J & F // Проекты {#jf}

